AWSTemplateFormatVersion: 2010-09-09
Description: AWS CloudFormation template to launch EC2 Instnace in VPC with Public and Private Subnets
Metadata: {
    "Version": "v1.0",
    "Comments": "Generated by Bibin Joseph",
    "AWS::CloudFormation::Interface": {
      "ParameterGroups": [
      {
        "Label": { "default": "Network Configuration" },
        "Parameters": ["CidrBlock", "pubAvailabilityZone", "pubSubnetCIDR", "privAvailabilityZone", "privSubnetCIDR"]
      },
      {
        "Label": { "default": "EC2 Instances Configuration" },
        "Parameters": ["InstanceName", "InstanceType", "Environment"]
      }
      ]
    }
  }
Parameters:
  CidrBlock:
    Description: VPC CIDR Block (eg 10.0.0.0/16)
    Type: String
    Default: 192.168.0.0/16 
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
  pubAvailabilityZone:
    Description: The AvailabilityZone to use for the first subnet
    Type: AWS::EC2::AvailabilityZone::Name
  pubSubnetCIDR:
    Description: VPC CIDR Block for the Public Subnet (eg 10.0.0.0/24)
    Type: String
    Default: 192.168.1.0/24 
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
  privAvailabilityZone:
    Description: The AvailabilityZone to use for the Second subnet
    Type: AWS::EC2::AvailabilityZone::Name
  privSubnetCIDR:
    Description: VPC CIDR Block for the Public Subnet (eg 10.0.0.0/24)
    Type: String
    Default: 192.168.2.0/24
    AllowedPattern: '((\d{1,3})\.){3}\d{1,3}/\d{1,2}'
  InstanceName:
    Type: String
  InstanceType:
      Description: EC2 instance type
      Type: String
      Default: t3.micro
      AllowedValues: [t2.nano, t2.micro, t2.small, t2.medium, t2.large, t2.xlarge, t2.2xlarge,
        t3.nano, t3.micro, t3.small, t3.medium, t3.large, t3.xlarge, t3.2xlarge,
        m4.large, m4.xlarge, m4.2xlarge, m4.4xlarge, m4.10xlarge,
        m5.large, m5.xlarge, m5.2xlarge, m5.4xlarge,
        c5.large, c5.xlarge, c5.2xlarge, c5.4xlarge, c5.9xlarge,
        g3.8xlarge,
        r5.large, r5.xlarge, r5.2xlarge, r5.4xlarge, r3.12xlarge,
        i3.xlarge, i3.2xlarge, i3.4xlarge, i3.8xlarge,
        d2.xlarge, d2.2xlarge, d2.4xlarge, d2.8xlarge]  
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  Environment:
    Description: Application environment for which this network is being created. e.g. Development/Production.
    Type: String
    Default: UAT
    AllowedValues: ["UAT", "DEV", "QA", "PROD"]    
  InstancePublicIP:
    Description: Specifies whether to launch instances with public IP addresses in your VPC.
    Type: String
    Default : "True"
    AllowedValues : ["False", "True"]
  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instances
    Type: String
    MinLength: 9
    MaxLength: 18
    Default: 0.0.0.0/0
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.      
Mappings: 
  RegionMap: 
    us-east-1: 
      HVMU: "ami-0ac80df6eff0e70b5"
      HVMR: "ami-098f16afa9edf40be"
    ap-south-1: 
      HVMU: "ami-02d55cb47e83a99a0"
      HVMR: "ami-052c08d70def0ac62"

Resources:
  myVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock:
        Ref: CidrBlock
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'
      InstanceTenancy: default
      Tags:
      - Key: Name
        Value: FirstCF-VPC
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value:
          Ref: AWS::StackName

  GatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId:
        Ref: InternetGateway
      VpcId:
        Ref: myVPC      
  #publicroutetable     
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:  
        Ref: myVPC
      Tags:
      - Key: Name
        Value: {Ref: 'AWS::StackName'}   
  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway
      RouteTableId:
        Ref: PublicRouteTable    
#NAT GATEWAY
# A NAT Gateway will be built and used if the user selected Private subnets and a Gateway instead of an EC2 instance. 
  NATGateway:
    Type: AWS::EC2::NatGateway
    DependsOn: ElasticIPAddress
    Properties:
        AllocationId:
          Fn::GetAtt:
          - ElasticIPAddress
          - AllocationId
        SubnetId:
          Ref: pubSubnet
        Tags:
        - Key: Name
          Value: natgatewayforCF
  ElasticIPAddress:
    Type: AWS::EC2::EIP
    DependsOn: GatewayAttachment
    Properties:
      Domain: myVPC
# Here is a private route table:
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: 
        Ref: myVPC
      Tags:
      - Key: Name
        Value: privateroutetable-myCF        
  PrivateRoute: # Private route table can access web via NAT (created below)
    Type: AWS::EC2::Route
    Properties:
      RouteTableId:
          Ref: PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
          #traffic through the NAT Gateway
      NatGatewayId:
          Ref: NATGateway 
  pubSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone:
        Ref: pubAvailabilityZone
      CidrBlock: 
        Ref: pubSubnetCIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value:
            Fn::Join:
              - '-'
              - [{Ref: 'AWS::StackName'}, {Ref: pubAvailabilityZone}]
      VpcId:
        Ref: myVPC      
  privSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: 
        Ref: privAvailabilityZone
      CidrBlock: 
        Ref: privSubnetCIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value:
            Fn::Join:
              - '-'
              - - AWS::StackName
                - privAvailabilityZone
      VpcId: 
        Ref: myVPC    
  pubSubnetAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      SubnetId:
        Ref: pubSubnet    
  privSubnetAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId:
        Ref: PrivateRouteTable
      SubnetId:
        Ref: privSubnet        
#SecurtiyGroupFrom the VPC and Ec2 Instnace
  WebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: myVPC-SG
      GroupDescription: Enable SSH access via port 22 and httpd port 80
      VpcId: 
        Ref: myVPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: '22'
        ToPort: '22'
        CidrIp:
          Ref: SSHLocation
      - IpProtocol: tcp
        FromPort: '80'
        ToPort: '80'
        CidrIp: 0.0.0.0/0    
#Ec2 instance with public subnet        
  Ec2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType:
        Ref: InstanceType
      ImageId: !FindInMap
        - RegionMap
        - !Ref AWS::Region
        - HVMR
      KeyName:
        Ref: KeyName
      NetworkInterfaces:
        - NetworkInterfaceId:
            Ref: NetworkInterfacesEC2
          DeviceIndex: 0
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash -x
            yum -y update
            # install apache
            yum install httpd -y  
            # start server
            systemctl start httpd
            systemctl enable httpd
            echo "<h1> Welcome To AWS EC2 Instance With Public and Private Subnets</h1>" >> /var/www/html/index.html
      Tags:
        - Key: Name
          Value: My EC2 Instance
        - Key: Type
          Value: Worker Instance
  EIPAddressEC2: #create elastic ip EC2 instance
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  EIPAddressEC2Association:
    Type: AWS::EC2::EIPAssociation #attach the elastic ip to the instance
    Properties:
      AllocationId: 
          Fn::GetAtt: # Fn::GetAtt is used to get an attribute inside a resource.
          - EIPAddressEC2
          - AllocationId
      NetworkInterfaceId: #We use Ref attribute to get the reference of a resource.
        Ref: NetworkInterfacesEC2
  NetworkInterfacesEC2:
    Type: AWS::EC2::NetworkInterface
    Properties:
      SubnetId:
        Ref: pubSubnet
      Description: Interface for controlling traffic such as SSH
      GroupSet: 
      - Ref: WebSecurityGroup
      SourceDestCheck: true
      Tags:
      - Key: Network
        Value: Control            
Outputs:
  InstanceId:
    Description: InstanceId of the newly created EC2 instance
    Value: !Ref 'Ec2Instance'
  WebServerPublicIPAddress:
    Description: 'The public IP address of the EC2 Instance.'
    Value: !GetAtt Ec2Instance.PublicDnsName
    Export:
      Name: !Sub '${AWS::StackName}-Public-DNS-Address'     
  InstanceIPAddress:
    Description: IP address of the newly created EC2 instance
    Value: !Ref 'EIPAddressEC2'      
